name: Codox Diagnostics & Self-Healing

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  diagnostics:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    env:
      GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
      GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      FIREBASE_KEY: ${{ secrets.FIREBASE_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      BACKEND_URL: "https://cleanpro-backend-5539254765.europe-west1.run.app"

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: üß≠ Prepare Codox Review
        run: |
          chmod +x review_report.sh
          echo "‚úÖ review_report.sh ready"

      - name: üß† Run Codox Diagnostics & Self-Healing
        run: |
          bash review_report.sh || echo "‚ö†Ô∏è Codox run finished with warnings"

      - name: üßæ Commit updates if any
        if: always()
        run: |
          git add .
          git commit -m "chore(codox): automated diagnostic & self-healing update" || echo "‚ÑπÔ∏è No changes to commit"
          git push origin main || echo "‚ö†Ô∏è Push skipped"
