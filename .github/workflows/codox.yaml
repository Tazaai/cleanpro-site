name: Codox Diagnostics & Self-Healing

on:
  workflow_dispatch: # âœ… Manual trigger in Actions tab

permissions:
  contents: write

jobs:
  diagnostics:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    env:
      GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
      GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      FIREBASE_KEY: ${{ secrets.FIREBASE_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      BACKEND_URL: "https://cleanpro-backend-5539254765.europe-west1.run.app"

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ§­ Sync latest code
        run: |
          git fetch origin main
          git reset --hard origin/main
          echo "âœ… Synced with latest main branch."

      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: âš™ï¸ Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT }}

      - name: ğŸ” Verify gcloud configuration
        run: |
          gcloud auth list
          gcloud config set project "$GCP_PROJECT"
          gcloud config set run/region europe-west1
          gcloud info

      - name: ğŸ§  Install Codox CLI
        run: |
          npm install -g codox prettier@3 || echo "âš ï¸ Codox CLI install warning"
          sudo apt-get update -y
          sudo apt-get install -y jq yamllint
          codox --version || echo "â„¹ï¸ Codox CLI ready"

      - name: ğŸ”§ Prepare diagnostic script
        run: |
          if [ -f ./review_report.sh ]; then
            chmod +x ./review_report.sh
            echo "âœ… review_report.sh ready"
          else
            echo "âŒ review_report.sh missing!"
            exit 1
          fi

      - name: ğŸ—ï¸ Validate required secrets
        run: |
          secrets=(GOOGLE_MAPS_API_KEY GCP_PROJECT GCP_SA_KEY GITHUB_TOKEN)
          missing=0
          for s in "${secrets[@]}"; do
            if [ -z "${!s}" ]; then
              echo "âŒ Missing: $s"
              missing=$((missing+1))
            else
              echo "âœ… $s OK"
            fi
          done
          [ $missing -gt 0 ] && exit 1 || echo "âœ… All secrets verified"

      - name: ğŸ³ Self-heal backend Dockerfile
        run: |
          echo "ğŸ” Checking backend/Dockerfile..."
          if [ -f backend/Dockerfile ]; then
            sed -i 's#WORKDIR /app$#WORKDIR /app/backend#' backend/Dockerfile || true
            grep -q 'EXPOSE 8080' backend/Dockerfile || echo 'EXPOSE 8080' >> backend/Dockerfile
            grep -q 'CMD' backend/Dockerfile || echo 'CMD ["node","index.js"]' >> backend/Dockerfile
            echo "âœ… Dockerfile verified and fixed if needed."
          else
            echo "âš ï¸ backend/Dockerfile not found â€” creating placeholder..."
