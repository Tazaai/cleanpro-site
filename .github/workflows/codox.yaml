name: Codox Diagnostics & Self-Healing

on:
  workflow_dispatch:   # âœ… Manual "Run workflow" button

permissions:
  contents: write

jobs:
  diagnostics:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    env:
      GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
      GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      FIREBASE_KEY: ${{ secrets.FIREBASE_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      BACKEND_URL: "https://cleanpro-backend-5539254765.europe-west1.run.app"

    steps:
      # âœ… Sync latest code
      - uses: actions/checkout@v4
      - name: ğŸ§­ Sync latest code
        run: |
          git fetch origin main
          git reset --hard origin/main
          echo "âœ… Synced with latest main branch."

      # âœ… Authenticate to Google Cloud
      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # âœ… Setup gcloud
      - name: âš™ï¸ Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT }}

      # âœ… Verify configuration
      - name: ğŸ” Verify gcloud configuration
        run: |
          gcloud auth list
          gcloud config set project "$GCP_PROJECT"
          gcloud config set run/region europe-west1
          gcloud info

      # âœ… Install Codox CLI
      - name: ğŸ§  Install Codox CLI
        run: |
          npm install -g codox prettier@3 || echo "âš ï¸ Codox CLI install warning"
          sudo apt-get update -y
          sudo apt-get install -y jq yamllint
          codox --version || echo "â„¹ï¸ Codox CLI ready"

      - name: ğŸ§­ Load Project Guide
        run: |
          PROJECT_CONTEXT=$(cat PROJECT_GUIDE.md || echo "")
          echo "$PROJECT_CONTEXT" > project_context.log
      # âœ… Prepare diagnostic script
      - name: ğŸ§­ Load Project Guide
        run: |
          PROJECT_CONTEXT=$(cat PROJECT_GUIDE.md || echo "")
          echo "$PROJECT_CONTEXT" > project_context.log
      - name: ï¿½ï¿½ Prepare diagnostic script
        run: |
          if [ -f ./review_report.sh ]; then
            chmod +x ./review_report.sh
            echo "âœ… review_report.sh ready"
          else
            echo "âŒ review_report.sh missing!"
            exit 1
          fi

      # âœ… Validate secrets
      - name: ğŸ—ï¸ Validate required secrets
        run: |
          secrets=(GOOGLE_MAPS_API_KEY GCP_PROJECT GCP_SA_KEY GITHUB_TOKEN)
          missing=0
          for s in "${secrets[@]}"; do
            if [ -z "${!s}" ]; then
              echo "âŒ Missing: $s"
              missing=$((missing+1))
            else
              echo "âœ… $s OK"
            fi
          done
          [ $missing -gt 0 ] && exit 1 || echo "âœ… All secrets verified"

      - name: ğŸ³ Self-heal backend Dockerfile
        run: |
          echo "ğŸ” Checking backend/Dockerfile..."
          if [ -f backend/Dockerfile ]; then
            grep -q "ENV HOST=0.0.0.0" backend/Dockerfile || echo "ENV HOST=0.0.0.0" >> backend/Dockerfile;
            grep -q "HEALTHCHECK CMD curl" backend/Dockerfile || echo "HEALTHCHECK CMD curl -f http://localhost:8080/ || exit 1" >> backend/Dockerfile;
            echo "âœ… Dockerfile verified and fixed.";
          fi
          grep -q "HEALTHCHECK CMD curl" backend/Dockerfile || echo "HEALTHCHECK CMD curl -f http://localhost:8080/ || exit 1" >> backend/Dockerfile;
          if [ -f backend/Dockerfile ]; then
          grep -q "HOST=0.0.0.0" backend/Dockerfile || echo "ENV HOST=0.0.0.0" >> backend/Dockerfile;
          grep -q "HEALTHCHECK CMD curl" backend/Dockerfile || echo "HEALTHCHECK CMD curl -f http://localhost:8080/ || exit 1" >> backend/Dockerfile;
            sed -i 's#WORKDIR /app$#WORKDIR /app/backend#' backend/Dockerfile || true
          grep -q "HOST=0.0.0.0" backend/Dockerfile || echo "ENV HOST=0.0.0.0" >> backend/Dockerfile;
          grep -q "HEALTHCHECK CMD curl" backend/Dockerfile || echo "HEALTHCHECK CMD curl -f http://localhost:8080/ || exit 1" >> backend/Dockerfile;
            grep -q 'EXPOSE 8080' backend/Dockerfile || echo 'EXPOSE 8080' >> backend/Dockerfile
          grep -q "HOST=0.0.0.0" backend/Dockerfile || echo "ENV HOST=0.0.0.0" >> backend/Dockerfile;
          grep -q "HEALTHCHECK CMD curl" backend/Dockerfile || echo "HEALTHCHECK CMD curl -f http://localhost:8080/ || exit 1" >> backend/Dockerfile;
            grep -q 'CMD' backend/Dockerfile || echo 'CMD ["node","index.js"]' >> backend/Dockerfile
          grep -q "HOST=0.0.0.0" backend/Dockerfile || echo "ENV HOST=0.0.0.0" >> backend/Dockerfile;
          grep -q "HEALTHCHECK CMD curl" backend/Dockerfile || echo "HEALTHCHECK CMD curl -f http://localhost:8080/ || exit 1" >> backend/Dockerfile;
            echo "âœ… Dockerfile verified and fixed if needed."
          grep -q "HOST=0.0.0.0" backend/Dockerfile || echo "ENV HOST=0.0.0.0" >> backend/Dockerfile;
          grep -q "HEALTHCHECK CMD curl" backend/Dockerfile || echo "HEALTHCHECK CMD curl -f http://localhost:8080/ || exit 1" >> backend/Dockerfile;
          else
          grep -q "HOST=0.0.0.0" backend/Dockerfile || echo "ENV HOST=0.0.0.0" >> backend/Dockerfile;
          grep -q "HEALTHCHECK CMD curl" backend/Dockerfile || echo "HEALTHCHECK CMD curl -f http://localhost:8080/ || exit 1" >> backend/Dockerfile;
            echo "âš ï¸ backend/Dockerfile not found â€” creating placeholder..."
          grep -q "HOST=0.0.0.0" backend/Dockerfile || echo "ENV HOST=0.0.0.0" >> backend/Dockerfile;
          grep -q "HEALTHCHECK CMD curl" backend/Dockerfile || echo "HEALTHCHECK CMD curl -f http://localhost:8080/ || exit 1" >> backend/Dockerfile;
            mkdir -p backend
            echo 'FROM node:20-slim' > backend/Dockerfile
            echo 'WORKDIR /app' >> backend/Dockerfile
            echo 'COPY . .' >> backend/Dockerfile
            echo 'RUN npm install --production' >> backend/Dockerfile
            echo 'EXPOSE 8080' >> backend/Dockerfile
            echo 'CMD ["node","index.js"]' >> backend/Dockerfile
            echo "âœ… New backend/Dockerfile created successfully."
          fi

      # âœ… Detect or generate missing backend routes
      - name: ğŸ§­ Detect or generate missing backend routes
        run: |
          echo "ğŸ” Scanning backend/routes for missing API files..."
          mkdir -p backend/routes
          routes=(services_api.mjs bookings_api.mjs quotes_api.mjs pricing_api.mjs)
          for r in "${routes[@]}"; do
            if [ ! -f "backend/routes/$r" ]; then
              echo "âš™ï¸ Creating recovery route: $r"
              echo 'import express from "express";' > "backend/routes/$r"
              echo 'const router = express.Router();' >> "backend/routes/$r"
              echo 'router.get("/", (req, res) => res.json({ message: "âœ… Auto-recovered route active" }));' >> "backend/routes/$r"
              echo 'export default router;' >> "backend/routes/$r"
              echo "âœ… $r created safely."
            else
              echo "âœ… $r exists â€” verified."
            fi
          done

      # âœ… Validate YAML syntax
      - name: ğŸ§© Validate YAML syntax
        run: |
          echo "ğŸ” Validating codox.yaml syntax..."
          yamllint .github/workflows/codox.yaml || echo "âš ï¸ YAML validation warnings only"

      # âœ… Validate frontend build
      - name: ğŸ§± Validate frontend build
        run: |
          if [ -d frontend ]; then
            echo "ğŸ§© Building frontend..."
            cd frontend
            if [ -f package.json ]; then
              npm install --legacy-peer-deps
              npm run build || echo "âš ï¸ Frontend build failed"
              echo "âš ï¸ Notice: google.maps.places.Autocomplete is legacy â€” consider migrating to PlaceAutocompleteElement later."
            else
              echo "â„¹ï¸ No package.json â€” skipping build"
            fi
            cd ..
          else
            echo "â„¹ï¸ No frontend directory â€” skipping build check"
          fi

      # âœ… Run diagnostic script
      - name: ğŸ“‹ Run Codox diagnostic
        run: |
          echo "ğŸš€ Running diagnostic..."
          npm install || true
          npm test || echo "âš ï¸ Frontend tests failed (non-fatal)"
          ./review_report.sh || true
          git add agent.md || true
          git commit -m "chore: Codox diagnostic report update" || echo "â„¹ï¸ No report changes"
          git push origin main || echo "âš ï¸ Push skipped"

      # âœ… Commit auto-fixes & redeploy backend
      - name: â™»ï¸ Commit Codox auto-fixes & redeploy
        if: always()
        run: |
          git add backend/ frontend/ || true
          git commit -m "chore: Codox auto-fix applied" || echo "â„¹ï¸ No fixes detected"
          git push origin main || echo "âš ï¸ Push skipped"
          if [ -f ./deploy_backend.sh ]; then
            echo "ğŸš€ Running backend deploy (only 1 attempt)..."
            bash ./deploy_backend.sh || echo "âš ï¸ Redeploy failed (non-fatal)"
          else
            echo "â„¹ï¸ deploy_backend.sh not found â€” skipping redeploy"
          fi

      - name: ğŸ”§ Auto-heal Cloud Run Dockerfile for backend
        run: |
          echo "ğŸš€ Auto-heal Cloud Run Dockerfile for backend..."
          if ! grep -q "backend/index.js" backend/Dockerfile; then
            cat > backend/Dockerfile <<EOF
            FROM node:18
            WORKDIR /app
            COPY package*.json ./
            RUN npm install --omit=dev
            COPY . .
            ENV PORT=8080
            ENV HOST=0.0.0.0
            EXPOSE 8080
            CMD ["node", "backend/index.js"]
            EOF
            git add backend/Dockerfile && git commit -m "auto-heal: rebuild Cloud Run Dockerfile for backend" || true
            git push || true
          fi
      - name: ğŸ©¹ Auto-heal Cloud Run startup
        run: |
          echo "ğŸ©¹ Checking backend for startup exit(1)..."
          gcloud run services update cleanpro-backend --set-env-vars="PORT=8080,HOST=0.0.0.0" --region=europe-west1 || true
          echo "âœ… Startup env ensured."
      # âœ… Verify backend health
      - name: ğŸ”§ Auto-heal Cloud Run Dockerfile for backend
        run: |
          echo "ğŸš€ Auto-heal Cloud Run Dockerfile for backend..."
          if ! grep -q "backend/index.js" backend/Dockerfile; then
            cat > backend/Dockerfile <<EOF
            FROM node:18
            WORKDIR /app
            COPY package*.json ./
            RUN npm install --omit=dev
            COPY . .
            ENV PORT=8080
            ENV HOST=0.0.0.0
            EXPOSE 8080
            CMD ["node", "backend/index.js"]
            EOF
            git add backend/Dockerfile && git commit -m "auto-heal: rebuild Cloud Run Dockerfile for backend" || true
            git push || true
          fi
      - name: ğŸ©¹ Auto-heal Cloud Run startup
        run: |
          echo "ğŸ©¹ Checking backend for startup exit(1)..."
          gcloud run services update cleanpro-backend --set-env-vars="PORT=8080,HOST=0.0.0.0" --region=europe-west1 || true
          echo "âœ… Startup env ensured."
      - name: ğŸ©º Verify backend health
        if: always()
        run: |
          echo "ğŸ©º Checking backend availability..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL")
          if [ "$STATUS" = "200" ]; then
            echo "âœ… Backend healthy"
          else
            echo "âŒ Backend returned HTTP $STATUS"
            exit 1
          fi


      echo "COPY . ." >> backend/Dockerfile

      echo "ENV PORT=8080" >> backend/Dockerfile

      echo "ENV HOST=0.0.0.0" >> backend/Dockerfile

      echo "EXPOSE 8080" >> backend/Dockerfile

      echo "CMD [\"node\",\"backend/index.js\"]" >> backend/Dockerfile

      git add backend/Dockerfile && git commit -m "auto-heal: rebuild backend Dockerfile (triggered by MODULE_NOT_FOUND)" || true

      git push || true

    fi

    echo "âœ… Auto-Repair Trigger completed."

        echo "ENV HOST=0.0.0.0" >> backend/Dockerfile

        echo "EXPOSE 8080" >> backend/Dockerfile

        echo "CMD [\"node\",\"backend/index.js\"]" >> backend/Dockerfile

        git add backend/Dockerfile && git commit -m "auto-heal: rebuild backend Dockerfile (triggered by MODULE_NOT_FOUND)" || true

        git push || true

      fi

      echo "âœ… Auto-Repair Trigger completed."
  # ğŸ¤– Codox Auto-Repair Trigger

  - name: ğŸ¤– Codox Auto-Repair Trigger

    if: failure() || always()

    run: |

      echo "ğŸ¤– Smart Agent detected failure, invoking auto-repair..."

      if grep -q "MODULE_NOT_FOUND" agent.md; then

        echo "âš™ï¸ Missing entrypoint â€” rebuilding backend Dockerfile"

        {

          echo "FROM node:18"

          echo "WORKDIR /app"

          echo "COPY package*.json ./"

          echo "RUN npm install --omit=dev"

          echo "COPY . ."

          echo "ENV PORT=8080"

          echo "ENV HOST=0.0.0.0"

          echo "EXPOSE 8080"

          echo "CMD [\"node\",\"backend/index.js\"]"

        } > backend/Dockerfile

        git add backend/Dockerfile && git commit -m "auto-heal: rebuild backend Dockerfile (triggered by MODULE_NOT_FOUND)" || true

        git push || true

      fi

      echo "âœ… Auto-Repair Trigger completed."
      # âœ… Global sanity check

      echo "COPY . ." >> backend/Dockerfile

      echo "ENV PORT=8080" >> backend/Dockerfile

      echo "ENV HOST=0.0.0.0" >> backend/Dockerfile

      echo "EXPOSE 8080" >> backend/Dockerfile

      echo "CMD [\"node\",\"backend/index.js\"]" >> backend/Dockerfile

      git add backend/Dockerfile && git commit -m "auto-heal: rebuild backend Dockerfile (triggered by MODULE_NOT_FOUND)" || true

      git push || true

    fi

    echo "âœ… Auto-Repair Trigger completed."

        echo "ENV HOST=0.0.0.0" >> backend/Dockerfile

        echo "EXPOSE 8080" >> backend/Dockerfile

        echo "CMD [\"node\",\"backend/index.js\"]" >> backend/Dockerfile

        git add backend/Dockerfile && git commit -m "auto-heal: rebuild backend Dockerfile (triggered by MODULE_NOT_FOUND)" || true

        git push || true

      fi

      echo "âœ… Auto-Repair Trigger completed."
  # ğŸ¤– Codox Auto-Repair Trigger

  - name: ğŸ¤– Codox Auto-Repair Trigger

    if: failure() || always()

    run: |

      echo "ğŸ¤– Smart Agent detected failure, invoking auto-repair..."

      if grep -q "MODULE_NOT_FOUND" agent.md; then

        echo "âš™ï¸ Missing entrypoint â€” rebuilding backend Dockerfile"

        {

          echo "FROM node:18"

          echo "WORKDIR /app"

          echo "COPY package*.json ./"

          echo "RUN npm install --omit=dev"

          echo "COPY . ."

          echo "ENV PORT=8080"

          echo "ENV HOST=0.0.0.0"

          echo "EXPOSE 8080"

          echo "CMD [\"node\",\"backend/index.js\"]"

        } > backend/Dockerfile

        git add backend/Dockerfile && git commit -m "auto-heal: rebuild backend Dockerfile (triggered by MODULE_NOT_FOUND)" || true

        git push || true

      fi

      echo "âœ… Auto-Repair Trigger completed."
      - name: ğŸ§  Global sanity check
        if: always()
        run: |
          grep -q "âŒ" agent.md && echo "âŒ Errors found in diagnostics" || echo "âœ… No critical errors detected"

      # ğŸ¤– Codox Smart Agent (Universal AI Fixer)
      - name: ğŸ¤– Codox Smart Agent
        if: always()
        run: |

