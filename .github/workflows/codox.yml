name: Codox Diagnostics & Self-Healing

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  diagnostics:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
      GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      BACKEND_URL: "https://cleanpro-backend-5539254765.europe-west1.run.app"

    steps:
      # ğŸ“¦ Checkout repository
      - uses: actions/checkout@v4

      # ğŸ”„ Permanent Sync â€” ensure GitHub uses latest code (prevents stale cache)
      - name: ğŸ”„ Sync latest main branch
        run: |
          git fetch origin main
          git reset --hard origin/main
          echo "âœ… Synced with latest code from main."

      # ğŸ” Authenticate with Google Cloud
      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # âš™ï¸ Setup gcloud
      - name: âš™ï¸ Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT }}

      # ğŸ” Verify configuration
      - name: ğŸ” Verify gcloud configuration
        run: |
          gcloud auth list
          gcloud config set project $GCP_PROJECT
          gcloud config set run/region europe-west1
          gcloud info

      # ğŸ§© Sync latest Codox GPT fixes
      - name: ğŸ§© Sync latest Codox GPT fixes
        run: |
          git fetch origin main
          git checkout main
          git pull origin main --rebase

      # ğŸ’¡ Install Codox globally (adds GPT capability)
      - name: ğŸ§  Install Codox for GPT self-healing
        run: npm install -g codox

      # ğŸ’¡ Ensure diagnostic script is executable and safe
      - name: ğŸ”§ Ensure review_report.sh executable (safe check)
        run: |
          if [ -f ./review_report.sh ]; then
            chmod +x ./review_report.sh
            echo "âœ… review_report.sh ready"
          else
            echo "âš ï¸ Skipping â€” review_report.sh not found."
          fi

      # âœ… Verify secrets before deploy
      - name: ğŸ§© Validate required secrets
        run: |
          required=(GOOGLE_MAPS_API_KEY GCP_PROJECT GCP_SA_KEY)
          missing=0
          for s in "${required[@]}"; do
            if [ -z "${!s}" ]; then
              echo "âŒ Missing secret: $s"
              missing=$((missing+1))
            else
              echo "âœ… $s is present"
            fi
          done
          if [ $missing -gt 0 ]; then
            echo "ğŸš« Aborting: $missing required secrets missing."
            exit 1
          fi

      # ğŸ³ Docker sanity
      - name: ğŸ³ Ensure fresh Docker image + Cloud Run sanity
        run: |
          echo "ğŸ§© Checking backend Dockerfile sanity..."
          if grep -q "WORKDIR /app$" backend/Dockerfile; then
            sed -i 's#WORKDIR /app#WORKDIR /app/backend#' backend/Dockerfile
            echo "âš™ï¸ WORKDIR fixed â†’ /app/backend"
          fi
          if [ "$(grep -c '^CMD' backend/Dockerfile)" -gt 1 ]; then
            echo "âš¡ Removing duplicate CMD lines"
            sed -i '0,/CMD/s//CMD/' backend/Dockerfile
            sed -i '/CMD/!b;n;d' backend/Dockerfile
          fi
          grep -q 'CMD \["npm","start"\]' backend/Dockerfile || echo 'CMD ["npm","start"]' >> backend/Dockerfile
          echo "âœ… Docker sanity complete."

      # âœ… Run diagnostics safely
      - name: ğŸ“‹ Run diagnostic script
        id: diagnostics
        run: |
          if [ -f ./review_report.sh ]; then
            ./review_report.sh
          else
            echo "âš ï¸ Skipping diagnostics (review_report.sh missing)."
          fi

      # âœ… Commit Codox auto-fixes and redeploy
      - name: â™»ï¸ Commit Codox auto-fixes and redeploy
        if: always()
        run: |
          echo "ğŸ“¦ Committing Codox auto-fixes..."
          git config --global user.name "Codox Bot"
          git config --global user.email "codox@bot.local"
          git add backend/ frontend/ || true
          git commit -m "chore: apply Codox auto-fixes from diagnostics" || echo "â„¹ï¸ No new changes to commit"
          git push origin main || echo "âš ï¸ Push skipped (protection or no changes)"
          echo "ğŸš€ Redeploying backend..."
          bash ./deploy_backend.sh || echo "âš ï¸ Redeploy failed, continuing."

      # ğŸ§  Collect logs
      - name: ğŸ§  Collect logs and reference
        if: always()
        continue-on-error: true
        run: |
          mkdir -p codox_logs
          gcloud run services logs read cleanpro-backend --limit=300 --format="value(textPayload)" > codox_logs/backend_logs.txt || echo "âš ï¸ No logs available"
          [ -f agent.md ] && cp agent.md codox_logs/review_reference.txt || echo "âš ï¸ Missing agent.md"
          echo "âœ… Logs collected successfully for Codox GPT analysis."

      # ğŸ§  Codox Auto-Correction & Redeploy (Retry)
      - name: ğŸ§  Codox Auto-Correction & Redeploy
        if: failure()
        run: |
          echo "ğŸ” Starting Codox self-heal..."
          MAX_RETRIES=3
          for i in $(seq 1 $MAX_RETRIES); do
            echo "ğŸ§  Attempt $i of $MAX_RETRIES"
            npx codox fix
            bash ./deploy_backend.sh && bash ./deploy_frontend.sh && break
            echo "âš ï¸ Attempt $i failed â€” retrying in 10s..."
            sleep 10
          done
          echo "âœ… Codox self-healing cycle completed."

      # ğŸ“Š Push diagnostic summary
      - name: ğŸ“Š Push diagnostic summary to reports branch
        if: always()
        continue-on-error: true
        run: |
          git config --global user.name "Codox Bot"
          git config --global user.email "codox@bot.local"
          mkdir -p reports
          [ -f agent.md ] && cp agent.md reports/$(date +'%Y-%m-%d_%H-%M')_report.md || echo "âš ï¸ No agent.md found"
          git checkout -B reports
          git add reports/
          git commit -m "Add diagnostic report $(date +'%Y-%m-%d %H:%M')" || echo "â„¹ï¸ No new report changes"
          git push origin reports --force || echo "âš ï¸ Push blocked by protection rules"

      # ğŸ”„ Verify backend after redeploy (with retry)
      - name: ğŸ”„ Verify backend after redeploy
        if: always()
        run: |
          echo "ğŸ©º Running post-deploy health check..."
          for i in {1..10}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL")
            if [ "$STATUS" = "200" ]; then
              echo "âœ… Backend responded 200 OK â€” deployment healthy."
              exit 0
            fi
            echo "âš ï¸ Attempt $i: backend not ready yet ($STATUS). Retrying in 10s..."
            sleep 10
          done
          echo "âŒ Backend never reached healthy state â€” check Cloud Run logs."
          exit 1

      # ğŸ”§ Ensure deploy scripts executable
      - name: ğŸ”§ Ensure deploy scripts executable
        run: |
          chmod +x ./deploy_backend.sh || true
          chmod +x ./deploy_frontend.sh || true

      # ğŸš€ Deploy backend (final step)
      - name: ğŸš€ Deploy backend
        run: ./deploy_backend.sh
