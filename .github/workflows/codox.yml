name: Codox Diagnostics & Self-Healing

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  diagnostics:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
      GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      BACKEND_URL: "https://cleanpro-backend-5539254765.europe-west1.run.app"

    steps:
      - uses: actions/checkout@v4

      - name: ðŸ”„ Sync latest main branch
        run: |
          git fetch origin main
          git reset --hard origin/main
          echo "âœ… Synced with latest code from main."

      - name: ðŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: âš™ï¸ Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT }}

      - name: ðŸ”Ž Verify gcloud configuration
        run: |
          gcloud auth list
          gcloud config set project $GCP_PROJECT
          gcloud config set run/region europe-west1
          gcloud info

      - name: ðŸ§© Sync latest Codox GPT fixes
        run: |
          git fetch origin main
          git checkout main
          git pull origin main --rebase

      - name: ðŸ§  Install Codox for GPT self-healing
        run: npm install -g codox

      - name: ðŸ”§ Ensure review_report.sh executable
        run: |
          [ -f ./review_report.sh ] && chmod +x ./review_report.sh && echo "âœ… review_report.sh ready" || echo "âš ï¸ Missing review_report.sh"

      - name: ðŸ§© Validate required secrets
        run: |
          required=(GOOGLE_MAPS_API_KEY GCP_PROJECT GCP_SA_KEY)
          missing=0
          for s in "${required[@]}"; do
            if [ -z "${!s}" ]; then
              echo "âŒ Missing: $s"
              missing=$((missing+1))
            else
              echo "âœ… $s OK"
            fi
          done
          [ $missing -gt 0 ] && exit 1 || echo "âœ… All secrets OK"

      # âœ… New automated Dockerfile pre-check before diagnostics
      - name: ðŸ³ Pre-Diagnostic Dockerfile Auto-Patch
        run: |
          echo "ðŸ§© Checking backend/Dockerfile..."
          if [ -f backend/Dockerfile ]; then
            sed -i 's#WORKDIR /app$#WORKDIR /app/backend#' backend/Dockerfile || true
            grep -q 'EXPOSE 8080' backend/Dockerfile || echo 'EXPOSE 8080' >> backend/Dockerfile
            if grep -q 'firebase_config.json' backend/Dockerfile; then
              sed -i '/firebase_config.json/d' backend/Dockerfile
              echo "âœ… Removed hard firebase_config copy"
            fi
            # Add optional firebase_config copy
            if ! grep -q "firebase_config optional" backend/Dockerfile; then
              cat >> backend/Dockerfile <<'EOF'
# firebase_config optional
RUN if [ -f firebase_config.json ]; then \
      cp firebase_config.json /app/firebase_config.json && \
      echo "âœ… firebase_config.json copied"; \
    else \
      echo "â„¹ï¸ firebase_config.json not found, skipping"; \
    fi
EOF
            fi
          else
            echo "âš ï¸ backend/Dockerfile not found!"
          fi

      - name: ðŸ“‹ Run diagnostic script
        run: ./review_report.sh

      - name: â™»ï¸ Commit Codox auto-fixes and redeploy
        if: always()
        run: |
          git config --global user.name "Codox Bot"
          git config --global user.email "codox@bot.local"
          git add backend/ frontend/ || true
          git commit -m "chore: apply Codox auto-fixes from diagnostics" || echo "â„¹ï¸ No new changes"
          git push origin main || echo "âš ï¸ Push skipped"
          bash ./deploy_backend.sh || echo "âš ï¸ Redeploy failed, continuing."

      - name: ðŸ”„ Verify backend after redeploy
        if: always()
        run: |
          echo "ðŸ©º Health check..."
          for i in {1..10}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL")
            if [ "$STATUS" = "200" ]; then
              echo "âœ… Backend OK"
              exit 0
            fi
            echo "âš ï¸ Attempt $i: $STATUS"
            sleep 10
          done
          echo "âŒ Backend not ready"
          exit 1
